Problem definition
------------------
Predict the 3D goal position of a single-arm reaching movement performed by a human using a partially observed 
hand trajectory. The approach is probabilistic, thus outputs are a distribution over possible goals of the hand
expressed as a set of samples drawn from such distribution.

Solution Approach
------------------
An analysis by synthesis approach is used to obtain the predictive distribution over reaching goals. Formulated as
a probabilistic approach, it is also known as approximate Bayesian inference. This approach is composed of five main 
components: 
* Observation model: Projects information form the world into an observation representation. This can be a perception 
  system that using sensor data is able to perceive the human and provide a representation of its hand motion. It can
  be based on a skeleton representation, a hand tracker, etc. In this example, the observation model obtains the hand
  trajectory as a sequence of 3D points.
  
* Generative model: This model encodes the knowledge we have about the world and its dynamics. It is able to project
  the internal representation into the observation space in order to verify that the internal representation beliefs
  match the actual observed evidence. In this example, the generative model provides a hand reaching trajectory from an
  initial hand position to a desired goal.
  
* Likelihood function: Intuitively this component is used to determine how likely is that an observation was produced 
  from the generative model. In essence is a function that compares two points in the observation space and is typically
  used to compare observed evidence with synthetic observations generated by the generative model. Which tries to verify
  that the current configuration of the generative model is able to explain evidence. In this example, the likelihood
  function provides a distance metric between two 3D trajectories.
  
* Sampling algorithm: Determines which is the next point in the generative model internal representation to evaluate.
  After multiple evaluation executions, the sampling algorithm will have produced a set of samples (with weights in
  the case of Importance Sampling methods) that represent the predictive posterior encoding the human intent. Depending
  on the application and on the predictive posterior knowledge, samples can be used later on to build a more compact 
  parametric distribution. **This repo depends on ais-benchmarks as the source for the
  used sampling algorithms.**
  
* Prior distribution: This can be used to add existing knowledge about possible reaching intent in form of a PDF. For 
  example, if there are objects on a table that are more likely to be reached. A prior distribution that has multiple 
  modes centered on object centroid might be designed.

Getting started
------------------
The follow the next steps in order to have the neural surrogate generative model inference pipeline ready. All the
main files have a header function with tunable parameters. 

1. Generate a trajectory dataset. (Default dataset is a toy dataset, a 10K+ dataset is recommended)
   1. Optional. Tune the arm controller limits and explore the effects of the different controller parameters 
      with arm_controller_tuining_gui.py
   2. Generate a dataset with the simulator using main_datageneration.py. It is possible to run multiple instances 
      to generate trajectories concurrently and merge the datasets. See scripts/generate_10K_multithread.sh
   3. Optional. Check that the dataset trajectories look alright with main_viewer_dataset.py                
      
2. Train the neural surrogate. 
    1. Using main_training.py. Configure network architecture and observation parameters to match the generated data.
    2. Optional: Check trajectory generation makes sense with main_viewer_neural_emulator.py

3. Run inference. Can be configured with: 
    1. Generative model to use. Currently avaliable: simulator, neural surrogate.
    2. Sampling algorithm. Currently avaliable: Grid or MCMC Metropolis-Hastings.
    3. Observation model. Currently available: 
        1. Simulator: Samples a random point in the parameter space and generates a trajectory.
        2. Random sample a trajectory from a dataset.
    4. Prior distribution. This can be any distribution that implements sampling and log_prob methods.
    5. Parameter domain boundaries for target quantities z ∋ ℝ^3 and and nuisance quantities n ∋ ℝ^8. Other
        relevant parameters like slack, prediction time window and sampling rate.

Definitions
-----------
- z ∋ ℝ^3: reaching intent final position (x,y,z). This is what we want to infer. 
- n ∋ ℝ^8: initial position (x,y,z) arm controller parameters (Kp, Ki, Kd, Kr, iClamp). These are extra 
           variables required by the generative model that we are not interested in inferring.
- x ∋ ?: unobservable state space, not used in this application.
- o ∋ ℝ^3*t: observed trajectory, projection of the state space into the observation space. A trajectory is a 
             timestamp ordered sequence of positions. i.e. a list of tuples (x,y,z,t) ordered by t 
- t ∋ ℕ+: number of observed points of the moving hand.
- ε ∋ ℝ^30: 30 discretized slack values.


Generative model
----------------
Describe the simulator. In the meantime see the paper.

Neural emulators
----------------
Comment on the problem of complex generative models and the use of neural surrogates to speed up the generative process.

Likelihood function and slack
-----------------------------
Describe how observations and synthetic observations are compared. The role of the slack parameter. In the meantime see 
the paper.

Future work
-----------
- Generalize for any initial position
    - Generate dataset from different starting positions with different controller parameters.
    - Change NN topology as follows and prepare training dataset
        - 30 inputs (past 0.3 sec trajectory @ 30Hz)
        - 90 outputs (next 1 sec trajectory @ 30Hz)
    - Perform inference by unrolling the state for an arbitrary time window

- Generalize for any trajectory length and prediction time window
